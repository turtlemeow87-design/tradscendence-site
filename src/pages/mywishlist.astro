---
import BaseLayout from "../layouts/BaseLayout.astro";

// ✅ Your Formspree endpoint
const FORMSPREE_ENDPOINT = "https://formspree.io/f/mblzzrqb";

// Edit this array to add/remove items.
// Numbers (1, 2, 3, …) are derived from the order here.
const WISHLIST = [
  { id: "Acoustic-bass-strings",  name: "Acoustic Bass Strings", url: "https://www.amazon.com/DAddario-EPBB170-5-Phosphor-5-String-Acoustic/dp/B00373N0ZO/ref=asc_df_B00373N0ZO/?tag=hyprod-20&linkCode=df0&hvadid=693366139103&hvpos=&hvnetw=g&hvrand=4152059029923750231&hvpone=&hvptwo=&hvqmt=&hvdev=c&hvdvcmdl=&hvlocint=&hvlocphy=9008464&hvtargid=pla-525652260601&psc=1&mcid=f0b8557d4bb8301e8a66f3c4653a80a2" },
  { id: "oud-rosin",      name: "Premium oud rosin",                       url: "https://example.com/oud-rosin" },
  { id: "zoom-h6-case",   name: "Zoom H6 padded case",                     url: "https://example.com/zoom-h6-case" },
];
---

<BaseLayout title="My Wish List — Tradscendence" description="A simple wishlist with one-click Formspree notifications.">
  <section class="mx-auto max-w-3xl px-4 py-10 space-y-8">
    <header class="space-y-2">
      <h1 class="font-display text-3xl md:text-4xl">My Wish List</h1>
      <p class="opacity-80">
        Click a checkbox to let me know you bought the item. I’ll get a Formspree message with the item number and details.
        This page doesn’t prevent duplicates—it’s just a notification line.
      </p>
      <p class="text-sm italic opacity-70">
        Tip: each item shows a <span class="font-semibold">number</span> (1, 2, 3, …). That number is included in the message.
      </p>
    </header>

    <ul id="wish-list" data-endpoint={FORMSPREE_ENDPOINT} class="space-y-4">
      {WISHLIST.map((item, idx) => (
        <li
          class="frame rounded-xl border border-[var(--accent-bronze)]/70 p-4 flex items-start justify-between gap-4"
          data-item-id={item.id}
          data-item-name={item.name}
          data-item-url={item.url}
          data-item-number={(idx + 1).toString()}
        >
          <div class="min-w-0">
            <div class="flex items-center gap-3">
              <span class="inline-flex h-6 w-6 items-center justify-center rounded-full border border-[var(--accent-bronze)] text-xs">
                {idx + 1}
              </span>
              <span class="item-title font-medium">{item.name}</span>
            </div>
            <div class="text-sm opacity-80">
              <a href={item.url} target="_blank" rel="noopener" class="gothic-link underline-offset-4 hover:underline">
                Where to buy →
              </a>
            </div>
            <div class="mt-2 text-sm">
              <span class="status opacity-70">Status: Ready</span>
            </div>
          </div>

          <label class="select-none flex items-center gap-2 shrink-0">
            <input
              type="checkbox"
              class="h-5 w-5 rounded border-[var(--accent-bronze)]"
              data-checkbox
              aria-label={`Notify purchase of ${item.name}`}
            />
            <span class="text-sm">I bought this</span>
          </label>
        </li>
      ))}
    </ul>

    <!-- No-JS fallback -->
    <noscript>
      <div class="mt-8 p-4 border rounded-xl border-[var(--accent-bronze)]/70">
        <p class="text-sm mb-2">JavaScript is off. Use this fallback to notify me:</p>
        <form action={FORMSPREE_ENDPOINT} method="POST" class="grid gap-2">
          <label class="text-sm">
            Which item?
            <select name="item_number" class="bg-ebony/60 frame rounded-xl px-3 py-2 border border-[var(--accent-bronze)]">
              {WISHLIST.map((item, idx) => (
                <option value={idx + 1}>{idx + 1} — {item.name}</option>
              ))}
            </select>
          </label>
          <input type="hidden" name="_subject" value="Wishlist (noscript) submission" />
          <input type="hidden" name="form_name" value="wishlist-click-noscript" />
          <input type="text" name="_gotcha" class="hidden" tabindex="-1" autocomplete="off" />
          <button class="px-3 py-2 rounded-xl border border-[var(--accent-bronze)] hover:bg-white/5" type="submit">
            Send notification
          </button>
        </form>
      </div>
    </noscript>
  </section>

  <!-- Plain script (not is:raw) so Astro can pass data- attributes -->
  <script>
    (function () {
      const list = document.getElementById("wish-list");
      if (!list) return;

      const ENDPOINT = list.dataset.endpoint;
      if (!ENDPOINT) {
        console.error("Formspree endpoint missing. Set FORMSPREE_ENDPOINT in the page.");
        return;
      }

      function setStatus(li, msg, isGood = false) {
        const s = li.querySelector(".status");
        if (s) {
          s.textContent = msg;
          s.classList.toggle("opacity-70", !isGood);
          s.classList.toggle("text-green-500", isGood);
          s.classList.toggle("text-red-400", !isGood && /sorry|error|fail/i.test(msg));
        }
      }

      async function notifyFormspree(payload) {
        const res = await fetch(ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json", "Accept": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!res.ok) {
          const text = await res.text().catch(() => "");
          throw new Error(`Formspree ${res.status}: ${text || "request failed"}`);
        }
        return res.json().catch(() => ({}));
      }

      [...list.querySelectorAll("li[data-item-id]")].forEach((li) => {
        const cb = li.querySelector("[data-checkbox]");
        if (!cb) return;

        cb.addEventListener("click", async (e) => {
          e.preventDefault(); // treat checkbox like a button

          const item = {
            id: li.getAttribute("data-item-id"),
            name: li.getAttribute("data-item-name"),
            url: li.getAttribute("data-item-url"),
            number: li.getAttribute("data-item-number"),
          };

          cb.disabled = true;
          setStatus(li, "Sending…");

          const payload = {
            _subject: `Wishlist: Item #${item.number} — ${item.name}`,
            form_name: "wishlist-click",
            item_number: item.number,
            item_id: item.id,
            item_name: item.name,
            item_url: item.url,
            page_path: location.pathname,
            page_title: document.title,
            tz: Intl.DateTimeFormat().resolvedOptions().timeZone || "unknown",
            when_iso: new Date().toISOString(),
            ua: navigator.userAgent,
            _gotcha: "",
          };

          try {
            await notifyFormspree(payload);
            setStatus(li, "Recorded — thanks!", true);
            li.classList.add("opacity-60"); // soft-dim to discourage repeat clicks
          } catch (err) {
            console.error(err);
            setStatus(li, "Sorry, couldn’t send. Check domain allowlist & endpoint.");
          } finally {
            cb.disabled = false;
          }
        });
      });
    })();
  </script>
</BaseLayout>
