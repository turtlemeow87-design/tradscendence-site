---
import BaseLayout from "../layouts/BaseLayout.astro";

// ‚úÖ Your Formspree endpoint
const FORMSPREE_ENDPOINT = "https://formspree.io/f/mblzzrqb";

// Edit this array to add/remove items.
const WISHLIST = [
  { id: "Acoustic Bass Strings",  name: "Acoustic Bass Strings", url: "https://www.amazon.com/DAddario-EPBB170-5-Phosphor-5-String-Acoustic/dp/B00373N0ZO/ref=asc_df_B00373N0ZO/?tag=hyprod-20&linkCode=df0&hvadid=693366139103&hvpos=&hvnetw=g&hvrand=4152059029923750231&hvpone=&hvptwo=&hvqmt=&hvdev=c&hvdvcmdl=&hvlocint=&hvlocphy=9008464&hvtargid=pla-525652260601&psc=1&mcid=f0b8557d4bb8301e8a66f3c4653a80a2" },
  { id: "oud-rosin",      name: "Premium oud rosin",                       url: "https://example.com/oud-rosin" },
  { id: "zoom-h6-case",   name: "Zoom H6 padded case",                     url: "https://example.com/zoom-h6-case" },
];
---

<BaseLayout title="My Wish List ‚Äî Tradscendence" description="Hunter‚Äôs wish list ‚Äî items supporters can buy.">
  <section class="mx-auto max-w-3xl px-4 py-10 space-y-8">
    <header class="space-y-3 text-center">
      <h1 class="font-display text-3xl md:text-4xl">My Wish List</h1>
      <p class="opacity-80 max-w-xl mx-auto">
        Browse the list below. Each item includes a direct purchase link.  
        If you pick something up for me, simply tick <em>‚ÄúCheck The Box If Purchased!!‚Äù</em> ‚Äî that‚Äôll quietly send me a note.
      </p>
    </header>

    <ul id="wish-list" data-endpoint={FORMSPREE_ENDPOINT} class="space-y-5">
      {WISHLIST.map((item, idx) => (
        <li
          class="frame rounded-xl border border-[var(--accent-bronze)]/70 p-5 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4"
          data-item-id={item.id}
          data-item-name={item.name}
          data-item-url={item.url}
          data-item-number={(idx + 1).toString()}
        >
          <div class="flex-1">
            <div class="flex items-center gap-3 flex-wrap">
              <span class="inline-flex h-7 w-7 items-center justify-center rounded-full border border-[var(--accent-bronze)] text-xs">
                {idx + 1}
              </span>
              <span class="item-title font-semibold text-lg">{item.name}</span>
            </div>

            <div class="mt-2">
              <a
                href={item.url}
                target="_blank"
                rel="noopener"
                class="inline-block px-3 py-1 rounded-lg border border-[var(--accent-gold)] text-[var(--accent-gold)] text-sm font-semibold tracking-wide hover:bg-[var(--accent-gold)] hover:text-ebony transition"
              >
                üõí Click here to purchase!!
              </a>
            </div>
          </div>

          <label class="select-none flex items-center gap-3 shrink-0">
            <input
              type="checkbox"
              class="h-7 w-7 rounded-lg border-2 border-[var(--accent-bronze)] cursor-pointer accent-[var(--accent-gold)]"
              data-checkbox
              aria-label={`Notify purchase of ${item.name}`}
            />
            <span class="text-sm font-medium text-[var(--accent-gold)] hover:text-[var(--accent-rosewood)] transition">
              I bought this item!
            </span>
          </label>
        </li>
      ))}
    </ul>

    <!-- No-JS fallback -->
    <noscript>
      <div class="mt-8 p-4 border rounded-xl border-[var(--accent-bronze)]/70">
        <p class="text-sm mb-2">JavaScript is off. Use this fallback to notify me:</p>
        <form action={FORMSPREE_ENDPOINT} method="POST" class="grid gap-2">
          <label class="text-sm">
            Which item?
            <select name="item_number" class="bg-ebony/60 frame rounded-xl px-3 py-2 border border-[var(--accent-bronze)]">
              {WISHLIST.map((item, idx) => (
                <option value={idx + 1}>{idx + 1} ‚Äî {item.name}</option>
              ))}
            </select>
          </label>
          <input type="hidden" name="_subject" value="Wishlist (noscript) submission" />
          <input type="hidden" name="form_name" value="wishlist-click-noscript" />
          <input type="text" name="_gotcha" class="hidden" tabindex="-1" autocomplete="off" />
          <button class="px-3 py-2 rounded-xl border border-[var(--accent-bronze)] hover:bg-white/5" type="submit">
            Send notification
          </button>
        </form>
      </div>
    </noscript>
  </section>

  <script>
    (function () {
      const list = document.getElementById("wish-list");
      if (!list) return;

      const ENDPOINT = list.dataset.endpoint;
      if (!ENDPOINT) {
        console.error("Formspree endpoint missing. Set FORMSPREE_ENDPOINT in the page.");
        return;
      }

      async function notifyFormspree(payload) {
        const res = await fetch(ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json", "Accept": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!res.ok) {
          const text = await res.text().catch(() => "");
          throw new Error(`Formspree ${res.status}: ${text || "request failed"}`);
        }
        return res.json().catch(() => ({}));
      }

      [...list.querySelectorAll("li[data-item-id]")].forEach((li) => {
        const cb = li.querySelector("[data-checkbox]");
        if (!cb) return;

        cb.addEventListener("click", async (e) => {
          e.preventDefault(); // treat checkbox as button

          const item = {
            id: li.getAttribute("data-item-id"),
            name: li.getAttribute("data-item-name"),
            url: li.getAttribute("data-item-url"),
            number: li.getAttribute("data-item-number"),
          };

          cb.disabled = true;

          const payload = {
            _subject: `Wishlist: Item #${item.number} ‚Äî ${item.name}`,
            form_name: "wishlist-click",
            item_number: item.number,
            item_id: item.id,
            item_name: item.name,
            item_url: item.url,
            page_path: location.pathname,
            page_title: document.title,
            tz: Intl.DateTimeFormat().resolvedOptions().timeZone || "unknown",
            when_iso: new Date().toISOString(),
            ua: navigator.userAgent,
            _gotcha: "",
          };

          try {
            await notifyFormspree(payload);
            li.classList.add("opacity-60");
            cb.nextElementSibling.textContent = "‚úÖ Thanks for picking this up!";
          } catch (err) {
            console.error(err);
            cb.nextElementSibling.textContent = "‚ùå Couldn‚Äôt send ‚Äî please try again.";
          } finally {
            cb.disabled = false;
          }
        });
      });
    })();
  </script>
</BaseLayout>
