---
import BaseLayout from "../layouts/BaseLayout.astro";

// ‚úÖ Your Formspree endpoint
const FORMSPREE_ENDPOINT = "https://formspree.io/f/mblzzrqb";

// Edit this array to add/remove items.
const WISHLIST = [
  { id: "acoustic-bass-strings", name: "Acoustic Bass Strings", url: "https://www.amazon.com/DAddario-EPBB170-5-Phosphor-5-String-Acoustic/dp/B00373N0ZO/ref=asc_df_B00373N0ZO/?tag=hyprod-20&linkCode=df0&hvadid=693366139103&hvpos=&hvnetw=g&hvrand=4152059029923750231&hvpone=&hvptwo=&hvqmt=&hvdev=c&hvdvcmdl=&hvlocint=&hvlocphy=9008464&hvtargid=pla-525652260601&psc=1&mcid=f0b8557d4bb8301e8a66f3c4653a80a2" },
  { id: "oud-rosin", name: "Premium Oud Rosin", url: "https://example.com/oud-rosin" },
  { id: "zoom-h6-case", name: "Zoom H6 Padded Case", url: "https://example.com/zoom-h6-case" },
];
---

<BaseLayout title="My Wish List ‚Äî Tradscendence" description="Hunter‚Äôs wish list ‚Äî items supporters can buy.">
  <section class="mx-auto max-w-3xl px-4 py-10 space-y-8">
    <header class="space-y-3 text-center">
      <h1 class="font-display text-3xl md:text-4xl">My Wish List</h1>
      <p class="opacity-80 max-w-xl mx-auto">
        Browse the list below. Each item includes a direct purchase link.  
        Once you‚Äôve bought something, check the box to let me know it‚Äôs been taken care of ‚Äî easy as that!
      </p>
    </header>

    <ul id="wish-list" data-endpoint={FORMSPREE_ENDPOINT} class="space-y-6">
      {WISHLIST.map((item, idx) => (
        <li
          class="frame rounded-xl border border-[var(--accent-bronze)]/70 p-5 flex flex-col gap-5"
          data-item-id={item.id}
          data-item-name={item.name}
          data-item-url={item.url}
          data-item-number={(idx + 1).toString()}
        >
          <div class="flex items-start gap-3">
            <span class="inline-flex h-7 w-7 items-center justify-center rounded-full border border-[var(--accent-bronze)] text-xs mt-1">
              {idx + 1}
            </span>
            <div>
              <h2 class="item-title font-semibold text-lg mb-2">{item.name}</h2>
              <a
                href={item.url}
                target="_blank"
                rel="noopener"
                class="inline-block px-4 py-2 rounded-lg border border-[var(--accent-gold)] text-[var(--accent-gold)] text-base font-semibold tracking-wide hover:bg-[var(--accent-gold)] hover:text-ebony transition"
              >
                üõí Click here to purchase
              </a>
            </div>
          </div>

          <div class="flex items-center gap-4 pl-10 sm:pl-12">
  <input
    type="checkbox"
    class="appearance-none relative h-9 w-9 shrink-0 border-2 border-[var(--accent-bronze)] rounded-md cursor-pointer
           transition-colors duration-200 ease-in-out
           checked:bg-[var(--accent-gold)] checked:border-[var(--accent-gold)]
           before:content-[''] before:absolute before:inset-0 before:flex before:items-center before:justify-center
           before:scale-0 checked:before:scale-100
           before:text-ebony before:font-bold before:text-lg
           before:content-['‚úî']"
    data-checkbox
    aria-label={`Notify purchase of ${item.name}`}
  />
  <span class="text-base font-medium text-ivory opacity-80 leading-tight">
    ‚úÖ Check this box once you‚Äôve purchased this item
  </span>
</div>

        </li>
      ))}
    </ul>

    <!-- No-JS fallback -->
    <noscript>
      <div class="mt-8 p-4 border rounded-xl border-[var(--accent-bronze)]/70">
        <p class="text-sm mb-2">JavaScript is off. Use this fallback to notify me:</p>
        <form action={FORMSPREE_ENDPOINT} method="POST" class="grid gap-2">
          <label class="text-sm">
            Which item?
            <select name="item_number" class="bg-ebony/60 frame rounded-xl px-3 py-2 border border-[var(--accent-bronze)]">
              {WISHLIST.map((item, idx) => (
                <option value={idx + 1}>{idx + 1} ‚Äî {item.name}</option>
              ))}
            </select>
          </label>
          <input type="hidden" name="_subject" value="Wishlist (noscript) submission" />
          <input type="hidden" name="form_name" value="wishlist-click-noscript" />
          <input type="text" name="_gotcha" class="hidden" tabindex="-1" autocomplete="off" />
          <button class="px-3 py-2 rounded-xl border border-[var(--accent-bronze)] hover:bg-white/5" type="submit">
            Send notification
          </button>
        </form>
      </div>
    </noscript>
  </section>

  <script>
    (function () {
      const list = document.getElementById("wish-list");
      if (!list) return;

      const ENDPOINT = list.dataset.endpoint;
      if (!ENDPOINT) {
        console.error("Formspree endpoint missing. Set FORMSPREE_ENDPOINT in the page.");
        return;
      }

      async function notifyFormspree(payload) {
        const res = await fetch(ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json", "Accept": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!res.ok) {
          const text = await res.text().catch(() => "");
          throw new Error(`Formspree ${res.status}: ${text || "request failed"}`);
        }
        return res.json().catch(() => ({}));
      }

      [...list.querySelectorAll("li[data-item-id]")].forEach((li) => {
        const cb = li.querySelector("[data-checkbox]");
        if (!cb) return;

        cb.addEventListener("click", async (e) => {
          e.preventDefault(); // treat checkbox as button

          const item = {
            id: li.getAttribute("data-item-id"),
            name: li.getAttribute("data-item-name"),
            url: li.getAttribute("data-item-url"),
            number: li.getAttribute("data-item-number"),
          };

          cb.disabled = true;

          const payload = {
            _subject: `Wishlist: Item #${item.number} ‚Äî ${item.name}`,
            form_name: "wishlist-click",
            item_number: item.number,
            item_id: item.id,
            item_name: item.name,
            item_url: item.url,
            page_path: location.pathname,
            page_title: document.title,
            tz: Intl.DateTimeFormat().resolvedOptions().timeZone || "unknown",
            when_iso: new Date().toISOString(),
            ua: navigator.userAgent,
            _gotcha: "",
          };

          try {
            await notifyFormspree(payload);
            li.classList.add("opacity-60");
            cb.nextElementSibling.textContent = "üéâ Thank you! This item‚Äôs been marked purchased.";
            cb.nextElementSibling.classList.add("text-[var(--accent-gold)]");
          } catch (err) {
            console.error(err);
            cb.nextElementSibling.textContent = "‚ùå Couldn‚Äôt send ‚Äî please try again.";
            cb.nextElementSibling.classList.add("text-red-400");
          } finally {
            cb.disabled = false;
          }
        });
      });
    })();
  </script>
</BaseLayout>
