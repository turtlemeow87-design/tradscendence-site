---
import BaseLayout from "../layouts/BaseLayout.astro";
const email = 'HunterEast.Musiq@gmail.com';

const title = "Contact / Booking — Tradscendence | Sound Beyond Borders";
const description =
  "Contact Hunter Eastland (Tradscendence), world & folk multi-instrumentalist in Richmond, VA. Book for weddings, ceremonies, funerals, small gatherings, or studio sessions.";

// Get API base URL from environment (defaults to current origin in production)
const apiBaseUrl = import.meta.env.PUBLIC_API_BASE_URL || '';
---
<BaseLayout {title} description={description} canonical="https://www.soundbeyondborders.com/Contact/">
  <section class="mx-auto max-w-3xl px-4 py-10 space-y-6">
    <h1 class="font-display text-3xl">Contact / Booking</h1>
    
    <!-- Error message container -->
    <div id="error-message" class="hidden rounded-xl border border-red-500/40 bg-red-500/10 p-4 text-red-200">
      <strong>Oops!</strong> <span id="error-text"></span>
    </div>
    
    <p class="opacity-80">Please share details about your event; I'll reply promptly. I will be coming from Richmond, VA.</p>

    <div class="rounded-xl border border-gold/40 bg-gold/10 p-3 text-sm leading-relaxed frame">
      <p><strong>I require booking inquiries to be at minimum one month out from the date of your event!</strong></p>
      <p class="mt-1"><strong>I'm available for intimate events: proposals, private weddings, other ceremonies, small gatherings, funerals, and studio sessions.</strong></p>
      <p class="mt-1"><strong>*Any particular dress code requests for an event will be taken into account once an official date/set of dates is established. Whether any dollar amount for attire is included in the customer fee, provided by the customer with no fee, or fully provided by me will be determined on a case-by-case basis. I am open-minded*</strong></p>
    </div>

    <form id="contact-form" class="grid gap-4">
      <!-- Required: Name -->
      <label class="grid gap-1">
        <span class="text-sm font-semibold">Your name *</span>
        <input class="bg-ebony/60 frame rounded-xl px-3 py-2 border border-[var(--accent-bronze)]"
               name="name" required />
      </label>

      <!-- Required: Email -->
      <label class="grid gap-1">
        <span class="text-sm font-semibold">Email *</span>
        <input class="bg-ebony/60 frame rounded-xl px-3 py-2 border border-[var(--accent-bronze)]"
               type="email" name="email" required />
      </label>

      <!-- Optional: Phone (auto-formatting) -->
      <label class="grid gap-1">
        <span class="text-sm">Phone (optional)</span>
        <input class="bg-ebony/60 frame rounded-xl px-3 py-2 border border-[var(--accent-bronze)]" 
               id="phone-input"
               name="phone"
               type="tel"
               placeholder="(804) 555-1234" />
      </label>

      <!-- Optional: Event date -->
      <label class="grid gap-1">
        <span class="text-sm">Event date (If Applicable)</span>
        <input class="bg-ebony/60 frame rounded-xl px-3 py-2 border border-[var(--accent-bronze)]"
               type="date" name="date" />
      </label>

      <!-- Required: Location -->
      <label class="grid gap-1">
        <span class="text-sm font-semibold">Location (city/venue) *</span>
        <span class="text-sm font-semibold">*Keep in mind: I will be coming from Richmond, VA. Transportation fees will be adjusted accordingly!*</span>
        <input class="bg-ebony/60 frame rounded-xl px-3 py-2 border border-[var(--accent-bronze)]"
               name="location" required />
      </label>

      <!-- Multi-select Instruments with Pills -->
      <div class="grid gap-2">
        <span class="text-sm">Instrument(s) (optional)</span>
        <div class="relative">
          <button type="button" id="instrument-dropdown-btn" 
                  class="w-full bg-ebony/60 frame rounded-xl px-3 py-2 border border-[var(--accent-bronze)] text-left flex justify-between items-center">
            <span id="instrument-placeholder">Select instruments...</span>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
          </button>
          <div id="instrument-dropdown" class="hidden absolute z-10 w-full mt-1 bg-[#181818] border border-gold/40 rounded-xl shadow-lg max-h-60 overflow-y-auto">
            <label class="flex items-center px-3 py-2 hover:bg-gold/10 cursor-pointer">
              <input type="checkbox" value="Surbahar" class="instrument-checkbox mr-2"> Surbahar
            </label>
            <label class="flex items-center px-3 py-2 hover:bg-gold/10 cursor-pointer">
              <input type="checkbox" value="Tanpura" class="instrument-checkbox mr-2"> Tanpura
            </label>
            <label class="flex items-center px-3 py-2 hover:bg-gold/10 cursor-pointer">
              <input type="checkbox" value="Rabab" class="instrument-checkbox mr-2"> Rabab
            </label>
            <label class="flex items-center px-3 py-2 hover:bg-gold/10 cursor-pointer">
              <input type="checkbox" value="Esraj" class="instrument-checkbox mr-2"> Esraj
            </label>
            <label class="flex items-center px-3 py-2 hover:bg-gold/10 cursor-pointer">
              <input type="checkbox" value="Kabak Kemane" class="instrument-checkbox mr-2"> Kabak Kemane
            </label>
            <label class="flex items-center px-3 py-2 hover:bg-gold/10 cursor-pointer">
              <input type="checkbox" value="Bağlama Saz" class="instrument-checkbox mr-2"> Bağlama Saz
            </label>
            <label class="flex items-center px-3 py-2 hover:bg-gold/10 cursor-pointer">
              <input type="checkbox" value="Divan Saz" class="instrument-checkbox mr-2"> Divan Saz
            </label>
            <label class="flex items-center px-3 py-2 hover:bg-gold/10 cursor-pointer">
              <input type="checkbox" value="Cümbüş Oud" class="instrument-checkbox mr-2"> Cümbüş Oud
            </label>
            <label class="flex items-center px-3 py-2 hover:bg-gold/10 cursor-pointer">
              <input type="checkbox" value="Cümbüş Tanbur" class="instrument-checkbox mr-2"> Cümbüş Tanbur
            </label>
            <label class="flex items-center px-3 py-2 hover:bg-gold/10 cursor-pointer">
              <input type="checkbox" value="Setar" class="instrument-checkbox mr-2"> Setar
            </label>
            <label class="flex items-center px-3 py-2 hover:bg-gold/10 cursor-pointer">
              <input type="checkbox" value="Duduk" class="instrument-checkbox mr-2"> Duduk
            </label>
            <label class="flex items-center px-3 py-2 hover:bg-gold/10 cursor-pointer">
              <input type="checkbox" value="Hulusi" class="instrument-checkbox mr-2"> Hulusi
            </label>
            <label class="flex items-center px-3 py-2 hover:bg-gold/10 cursor-pointer">
              <input type="checkbox" value="Pipa" class="instrument-checkbox mr-2"> Pipa
            </label>
            <label class="flex items-center px-3 py-2 hover:bg-gold/10 cursor-pointer">
              <input type="checkbox" value="Arabic Oud" class="instrument-checkbox mr-2"> Arabic Oud
            </label>
            <label class="flex items-center px-3 py-2 hover:bg-gold/10 cursor-pointer">
              <input type="checkbox" value="Turkish Oud" class="instrument-checkbox mr-2"> Turkish Oud
            </label>
            <label class="flex items-center px-3 py-2 hover:bg-gold/10 cursor-pointer">
              <input type="checkbox" value="Azeri Tar" class="instrument-checkbox mr-2"> Azeri Tar
            </label>
            <label class="flex items-center px-3 py-2 hover:bg-gold/10 cursor-pointer">
              <input type="checkbox" value="Octave Mandolin" class="instrument-checkbox mr-2"> Octave Mandolin
            </label>
          </div>
        </div>
        <!-- Pills display -->
        <div id="instrument-pills" class="flex flex-wrap gap-2"></div>
      </div>

      <!-- Multi-select Genres with Pills -->
      <div class="grid gap-2">
        <span class="text-sm">Genre(s) (optional)</span>
        <div class="relative">
          <button type="button" id="genre-dropdown-btn" 
                  class="w-full bg-ebony/60 frame rounded-xl px-3 py-2 border border-[var(--accent-bronze)] text-left flex justify-between items-center">
            <span id="genre-placeholder">Select genres...</span>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
          </button>
          <div id="genre-dropdown" class="hidden absolute z-10 w-full mt-1 bg-[#181818] border border-gold/40 rounded-xl shadow-lg max-h-60 overflow-y-auto">
            <label class="flex items-center px-3 py-2 hover:bg-gold/10 cursor-pointer">
              <input type="checkbox" value="Classical" class="genre-checkbox mr-2"> Classical
            </label>
            <label class="flex items-center px-3 py-2 hover:bg-gold/10 cursor-pointer">
              <input type="checkbox" value="Blues" class="genre-checkbox mr-2"> Blues
            </label>
            <label class="flex items-center px-3 py-2 hover:bg-gold/10 cursor-pointer">
              <input type="checkbox" value="Traditional/Folk" class="genre-checkbox mr-2"> Traditional/Folk
            </label>
            <label class="flex items-center px-3 py-2 hover:bg-gold/10 cursor-pointer">
              <input type="checkbox" value="Metal/Alternative" class="genre-checkbox mr-2"> Metal/Alternative
            </label>
            <label class="flex items-center px-3 py-2 hover:bg-gold/10 cursor-pointer">
              <input type="checkbox" value="Pop" class="genre-checkbox mr-2"> Pop
            </label>
            <label class="flex items-center px-3 py-2 hover:bg-gold/10 cursor-pointer">
              <input type="checkbox" value="Rock" class="genre-checkbox mr-2"> Rock
            </label>
            <label class="flex items-center px-3 py-2 hover:bg-gold/10 cursor-pointer">
              <input type="checkbox" value="Oldies" class="genre-checkbox mr-2"> Oldies
            </label>
            <label class="flex items-center px-3 py-2 hover:bg-gold/10 cursor-pointer">
              <input type="checkbox" value="Other" class="genre-checkbox mr-2"> Other
            </label>
          </div>
        </div>
        <!-- Pills display -->
        <div id="genre-pills" class="flex flex-wrap gap-2"></div>
      </div>

      <!-- Custom genre text (shown when "Other" is selected) -->
      <label id="genre-other-wrap" class="grid gap-1 hidden">
        <span class="text-sm">Describe the genre(s) / vibe</span>
        <textarea name="genre_other"
                  rows="3"
                  class="bg-ebony/60 frame rounded-xl px-3 py-2 border border-[var(--accent-bronze)]"
                  placeholder="e.g., mystical, atmospheric, Sufi-inspired, cinematic"></textarea>
      </label>

      <!-- Required: Message -->
      <label class="grid gap-1">
        <span class="text-sm font-semibold">Message *</span>
        <textarea class="bg-ebony/60 frame rounded-xl px-3 py-2 border border-[var(--accent-bronze)]"
                  rows="6" name="message" required></textarea>
      </label>

      <!-- Honeypot (hidden spam trap) -->
      <input type="text" name="honeypot" autocomplete="off" tabindex="-1" style="position:absolute;left:-9999px" />

      <!-- Hidden form identifier -->
      <input type="hidden" name="formName" value="Contact Page" />

      <div class="flex flex-wrap items-center gap-6 mt-2">
        <button
          class="rounded-xl px-4 py-2 bg-gold text-ivory hover:bg-golddark hover:text-rosewood font-semibold frame"
          type="submit"
          id="submit-btn">
          Send
        </button>
        <a class="gothic-link" href={`mailto:${email}`}>
          Or ... Don't want to use the form? Just click here and email me.
        </a>
      </div>
    </form>
  </section>

  <style is:global>
    input, textarea, button[type="button"] {
  scroll-margin-top: 200px;
}
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.25rem 0.75rem;
      background: var(--accent-bronze);
      color: var(--ivory);
      border-radius: 9999px;
      font-size: 0.875rem;
    }
    .pill button {
      background: none;
      border: none;
      color: inherit;
      cursor: pointer;
      padding: 0;
      font-size: 1.25rem;
      line-height: 1;
    }
    .pill button:hover {
      color: var(--rosewood);
    }
  </style>

  <script define:vars={{ apiBaseUrl }}>
    // Phone auto-formatting
    const phoneInput = document.getElementById('phone-input');
    if (phoneInput) {
      phoneInput.addEventListener('input', (e) => {
        const input = e.target;
        let value = input.value.replace(/\D/g, ''); // Remove non-digits
        if (value.length === 11 && value.startsWith('1')) value = value.slice(1);
        if (value.length > 10) value = value.slice(0, 10);
        
        if (value.length >= 6) {
          value = `(${value.slice(0, 3)}) ${value.slice(3, 6)}-${value.slice(6)}`;
        } else if (value.length >= 3) {
          value = `(${value.slice(0, 3)}) ${value.slice(3)}`;
        }
        
        input.value = value;
      });
    }

    // Multi-select dropdown functionality
    function setupMultiSelect(
      btnId,
      dropdownId,
      checkboxClass,
      pillsId,
      placeholderId
    ) {
      const btn = document.getElementById(btnId);
      const dropdown = document.getElementById(dropdownId);
      const checkboxes = document.querySelectorAll(`.${checkboxClass}`);
      const pillsContainer = document.getElementById(pillsId);
      const placeholder = document.getElementById(placeholderId);

      if (!btn || !dropdown || !pillsContainer || !placeholder) return;

      const selected = new Set();

      // Toggle dropdown
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        dropdown.classList.toggle('hidden');
      });

      // Close dropdown when clicking outside
      document.addEventListener('click', () => {
        dropdown.classList.add('hidden');
      });

      dropdown.addEventListener('click', (e) => {
        e.stopPropagation();
      });

      // Handle checkbox changes
      checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', () => {
          if (checkbox.checked) {
            selected.add(checkbox.value);
          } else {
            selected.delete(checkbox.value);
          }
          updatePills();
        });
      });

      function updatePills() {
        if (!pillsContainer || !placeholder) return;
        
        pillsContainer.innerHTML = '';
        
        if (selected.size === 0) {
          placeholder.textContent = btnId.includes('instrument') 
            ? 'Select instruments...' 
            : 'Select genres...';
          return;
        }

        placeholder.textContent = `${selected.size} selected`;

        selected.forEach(value => {
          const pill = document.createElement('div');
          pill.className = 'pill';
          pill.innerHTML = `
            ${value}
            <button type="button" data-value="${value}">&times;</button>
          `;
          
          const removeBtn = pill.querySelector('button');
          removeBtn?.addEventListener('click', () => {
  selected.delete(value);
  const checkbox = Array.from(checkboxes).find(cb => cb.value === value);
  if (checkbox) {
    checkbox.checked = false;
    checkbox.dispatchEvent(new Event('change'));
  }
  updatePills();
});
          
          pillsContainer.appendChild(pill);
        });
      }

      // Return selected values for form submission
      return () => Array.from(selected);
    }

    const getInstruments = setupMultiSelect(
      'instrument-dropdown-btn',
      'instrument-dropdown',
      'instrument-checkbox',
      'instrument-pills',
      'instrument-placeholder'
    );

    const getGenres = setupMultiSelect(
      'genre-dropdown-btn',
      'genre-dropdown',
      'genre-checkbox',
      'genre-pills',
      'genre-placeholder'
    );

    // Show/hide "Other" genre text field
    const genreCheckboxes = document.querySelectorAll('.genre-checkbox');
    const genreOtherWrap = document.getElementById('genre-other-wrap');
    
    genreCheckboxes.forEach(checkbox => {
      checkbox.addEventListener('change', () => {
        const otherSelected = Array.from(genreCheckboxes).some(cb => cb.value === 'Other' && cb.checked);
        genreOtherWrap?.classList.toggle('hidden', !otherSelected);
      });
    });

    // Form submission
    const form = document.getElementById('contact-form');
    const submitBtn = document.getElementById('submit-btn');
    const errorMessage = document.getElementById('error-message');
    const errorText = document.getElementById('error-text');

    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      // Scroll to first invalid field
const firstInvalid = form.querySelector(':invalid');
if (firstInvalid) {
  firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
  return;
}

      // Disable submit button
      submitBtn.disabled = true;
      submitBtn.textContent = 'Sending...';
      errorMessage?.classList.add('hidden');

      const formData = new FormData(form);
      const payload = {};

      // Get all form fields
      formData.forEach((value, key) => {
        payload[key] = value;
      });

      // Add multi-select arrays
      payload.instruments = getInstruments ? getInstruments() : [];
      payload.genres = getGenres ? getGenres() : [];

      // Build API URL (use apiBaseUrl if set, otherwise relative path)
      const apiUrl = apiBaseUrl ? `${apiBaseUrl}/api/contact.json` : '/api/contact.json';
      
      console.log('Submitting to:', apiUrl);

      try {
        const res = await fetch(apiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });

        const data = await res.json().catch(() => ({}));

        if (!res.ok) {
          // Show validation errors
          if (data.errors) {
            const errorList = Object.values(data.errors).join(' ');
            errorText.textContent = errorList;
          } else {
            errorText.textContent = data.error || 'Something went wrong. Please try again.';
          }
          errorMessage?.classList.remove('hidden');
          
          submitBtn.disabled = false;
          submitBtn.textContent = 'Send';
          return;
        }

        // Success! Redirect to thanks page
        window.location.href = '/thanks';
        
      } catch (err) {
        console.error('Submission error:', err);
        errorText.textContent = 'Network error. Please check your connection and try again.';
        errorMessage?.classList.remove('hidden');
        
        submitBtn.disabled = false;
        submitBtn.textContent = 'Send';
      }
    });
  </script>
</BaseLayout>