---
import BaseLayout from "../../layouts/BaseLayout.astro";
import Divider from "../../components/Divider.astro";

// ✅ SEO
const title = "My Instruments — Tradscendence | Sound Beyond Borders";
const description =
  "Browse Hunter Eastland’s world & folk instruments. Hear quick audio teasers and jump to pages: Surbahar, Oud, Saz, Rabab, Esraj, Duduk, Tar, and more.";

/** Latest YouTube embed (manual) */
const LATEST_YT = {
  id: "AgSGd3ur2mQ?si=FZBTfCBkOU211cSH", // e.g. 'dQw4w9WgXcQ'
  isShort: false,                        // true if the latest is a Short (9:16)
  title: "My latest performance",        // caption + a11y title
  instrumentLink: "/instruments/CumbusOud",  // point to the featured instrument (or '/instruments')
};

const embedUrl = `https://www.youtube.com/embed/${LATEST_YT.id}?rel=0`;
const watchUrl = `https://youtu.be/${LATEST_YT.id}`;

const items = [
  { name: "Indian Surbahar",        file: "/media/surbahar.m4a",       href: "/instruments/Surbahar" },
  { name: "Indian Tanpura",         file: "/media/tanpura.m4a",        href: "/instruments/Tanpura"  },
  { name: "Pakistani Rabab",        file: "/media/rabab.m4a",          href: "/instruments/Rabab" },
  { name: "Indian Esraj",           file: "/media/esraj.m4a",          href: "/instruments/Esraj" },
  { name: "Turkish Kabak Kemane",   file: "/media/kemane.m4a",         href: "/coming-soon" },
  { name: "Turkish Baglama Saz",    file: "/media/baglamasaz1.m4a",    href: "/instruments/BaglamaSaz" },
  { name: "Turkish Divan Saz",      file: "/media/divansaz.m4a",       href: "/instruments/DivanSaz" },
  { name: "Turkish Cümbüş Tanbur",  file: "/media/tanbur.m4a",         href: "/instruments/Tanbur" },
  { name: "Turkish Cümbüş Oud",     file: "/media/CumbusOud.m4a",      href: "/instruments/CumbusOud" },
  { name: "Persian Setar",          file: "/media/setar.m4a",          href: "/instruments/Setar" },
  { name: "Armenian Duduk",         file: "/media/duduk.m4a",          href: "/instruments/Duduk" },
  { name: "Chinese Hulusi",         file: "/media/hulusi.m4a",         href: "/instruments/Hulusi" },
  { name: "Chinese Pipa",           file: "/media/pipa.m4a",           href: "/coming-soon" },
  { name: "Arabic Oud",             file: "/media/arabicoud.m4a",      href: "/instruments/ArabicOud" },
  { name: "Turkish Oud",            file: "/media/turkishoud.m4a",     href: "/instruments/TOud" }, // ← verify this path
  { name: "Azeri Tar",              file: "/media/tar.m4a",            href: "/instruments/AzeriTar" },
  { name: "Octave Mandolin",        file: "/media/octavemandolin.m4a", href: "/instruments/OM" },
];
---

<BaseLayout {title} description={description} canonical="https://www.soundbeyondborders.com/instruments/">
  <section class="instruments-page mx-auto max-w-6xl px-4 py-10 space-y-6">
    <h1 class="font-display text-3xl">My Instruments</h1>
    <p class="opacity-80">
      Instruments that I've collected and learned to play over the years. Hit the play
      button to <b>hear</b> a quick teaser that I made! Clicking the instrument's name sends
      you to the instrument's page. I hope you find a sound that you like! :)
    </p>

    <ul class="grid gap-4 sm:grid-cols-2 md:grid-cols-3">
      {items.map(({ name, file, href }) => (
        <li class="frame rounded-xl p-3 flex items-center justify-between">
          <a class="gothic-link" href={href}>{name}</a>
          <button
            type="button"
            class="opacity-60 hover:opacity-100 transition"
            data-audio={file}
            aria-label={`Play ${name} sample`}
          >
            ▶︎
          </button>
        </li>
      ))}
    </ul>
  </section>

  <Divider />

  <!-- Latest YouTube video (bottom of page, above footer) -->
  <section id="latest-video" class="mx-auto max-w-6xl px-4 pb-10 scroll-mt-24">
    <h2 class="font-display text-xl sm:text-2xl mb-3 sm:mb-4">
      My Latest Youtube Upload!
    </h2>

    <figure class="space-y-3">
      <!-- Responsive frame that adapts to Shorts vs. regular -->
      <div class={`relative w-full ${LATEST_YT.isShort ? 'aspect-[9/16]' : 'aspect-video'} rounded-2xl overflow-hidden frame shadow-soft`}>
        <iframe
          class="absolute inset-0 w-full h-full"
          src={embedUrl}
          title={LATEST_YT.title}
          loading="lazy"
          referrerpolicy="strict-origin-when-cross-origin"
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
          allowfullscreen
        ></iframe>
      </div>

      <figcaption class="text-sm opacity-80 flex flex-col sm:flex-row sm:items-center sm:gap-3">
        <span class="font-display">{LATEST_YT.title}</span>
        <a href={watchUrl} target="_blank" rel="noopener" class="gothic-link font-bold">
          Watch on YouTube →
        </a>
      </figcaption>
    </figure>

    <!-- “Explore this instrument” link, matching your CTA style -->
    <div class="pt-4">
      <a 
        href={LATEST_YT.instrumentLink ?? '/instruments'} 
        class="group gothic-link font-bold inline-flex items-center gap-1 drop-shadow-[0_0_2px_ivory]">
        <span>Explore this instrument more</span>
        <span aria-hidden="true" class="transition-transform group-hover:translate-x-0.5">→</span>
      </a>
    </div>
  </section>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const supportsHover = window.matchMedia('(hover: hover)').matches;

      const players = new Map();
      let current = null;

      function getPlayer(src) {
        if (!players.has(src)) {
          const a = new Audio(src);
          a.preload = 'none';
          players.set(src, a);
        }
        return players.get(src);
      }

      function stopCurrent() {
        if (current && !current.paused) {
          current.pause();
          current.currentTime = 0;
        }
      }

      async function play(src) {
        stopCurrent();
        const a = getPlayer(src);
        current = a;
        a.currentTime = 0;
        a.volume = 0.9;
        try {
          await a.play();
        } catch (err) {
          // Autoplay blocked or other issue — fail silently for hover
        }
      }

      document.querySelectorAll('[data-audio]').forEach((btn) => {
        const src = btn.getAttribute('data-audio');

        btn.addEventListener('click', () => play(src), { passive: true });

        if (supportsHover) {
          btn.addEventListener('mouseenter', () => play(src));
          btn.addEventListener('mouseleave', () => stopCurrent());
          btn.addEventListener('blur', () => stopCurrent());
        }
      });

      document.addEventListener('visibilitychange', () => {
        if (document.hidden) stopCurrent();
      });
    });
  </script>

  <!-- Smooth-scrolling + anchor offset in case you link here from elsewhere -->
  <style is:global>
    html { scroll-behavior: smooth; }
    #latest-video { scroll-margin-top: 96px; }
  </style>

  <style>
    .instruments-page ul li.frame {
      position: relative;
      background: linear-gradient(
        to right,
        rgba(205, 127, 50, 0.15),
        transparent
      );
      border-radius: 0.75rem;
      overflow: hidden;
    }

    .instruments-page ul li.frame::before {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      padding: 1px;
      background: linear-gradient(
        to right,
        rgba(205, 127, 50, 0.8),
        transparent
      );
      -webkit-mask:
        linear-gradient(#fff 0 0) content-box,
        linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
              mask-composite: exclude;
      pointer-events: none;
    }

    .instruments-page button[data-audio] {
      font-size: 1.75rem;
      color: var(--accent-gold, #C2A45F);
      text-shadow:
        2px 0 var(--bronze, #CD7F32),
       -2px 0 var(--bronze, #CD7F32),
        0 2px var(--bronze, #CD7F32),
        0 -2px var(--bronze, #CD7F32),
        2px 2px var(--bronze, #CD7F32),
       -3px -3px var(--bronze, #CD7F32),
        2px -2px var(--bronze, #CD7F32),
       -3px 3px var(--bronze, #CD7F32);
    }
  </style>
</BaseLayout>
