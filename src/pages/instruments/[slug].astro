---
// src/pages/instruments/[slug].astro
// This ONE file replaces all individual instrument .astro pages
import BaseLayout from "../../layouts/BaseLayout.astro";
import Divider from "../../components/Divider.astro";
import { neon } from "@neondatabase/serverless";

const { slug } = Astro.params;
const sql = neon(import.meta.env.DATABASE_URL);

// Fetch instrument
const instruments = await sql`SELECT * FROM instruments WHERE slug = ${slug}`;
if (instruments.length === 0) {
  return Astro.redirect("/instruments");
}
const inst = instruments[0];

// Fetch videos
const videos = await sql`
  SELECT label, video_type AS type, src, poster, aspect_ratio AS ratio
  FROM instrument_videos
  WHERE instrument_id = ${inst.id}
  ORDER BY display_order ASC
`;
// Add id field for tab system
const videoTabs = videos.map((v: any, i: number) => ({
  ...v,
  id: `v${i + 1}`,
}));

// Fetch moods
const moods = await sql`
  SELECT label, audio_file
  FROM instrument_moods
  WHERE instrument_id = ${inst.id}
  ORDER BY display_order ASC
`;

// SEO
const title = inst.seo_title || `${inst.name} — Tradscendence | Sound Beyond Borders`;
const description = inst.seo_description || `Explore the ${inst.name} with Hunter Eastland.`;
---

<BaseLayout {title} description={description}>
  <section class="mx-auto max-w-6xl px-4 py-10 space-y-8">
    <header class="space-y-2">
      <h1 class="font-display text-3xl md:text-4xl">{inst.name}</h1>
      {inst.tagline && <p class="opacity-80 max-w-3xl">{inst.tagline}</p>}
    </header>

    <!-- ═══ Tabbed Hero Video (only renders if videos exist) ═══ -->
    {videoTabs.length > 0 && (
      <section class="rounded-2xl overflow-hidden frame border border-black/40 bg-black/20">
        <div class="tab-strip px-3 pt-3 sm:px-4 sm:pt-4" role="tablist" aria-label="Choose performance">
          {videoTabs.map((v: any, i: number) => (
            <button
              class="tab-button"
              data-tab={v.id}
              role="tab"
              aria-selected={i === 0 ? "true" : "false"}
              aria-controls={`pane-${v.id}`}
              id={`tab-${v.id}`}
            >
              {v.label}
            </button>
          ))}
        </div>

        <div id="video-shell" class="relative w-full bg-black" style="aspect-ratio: var(--ar, 16 / 9);">
          {videoTabs.map((v: any, i: number) => (
            <div
              id={`pane-${v.id}`}
              data-pane={v.id}
              role="tabpanel"
              aria-labelledby={`tab-${v.id}`}
              class={`video-pane ${i === 0 ? "is-active" : ""}`}
              data-ratio={v.ratio || ""}
            >
              {v.type === "video" && v.src ? (
                <video
                  class="h-full w-full object-contain"
                  controls
                  playsinline
                  preload="metadata"
                  poster={v.poster || undefined}
                >
                  <source src={v.src} />
                </video>
              ) : v.type === "iframe" && v.src ? (
                <iframe
                  class="h-full w-full"
                  src={v.src}
                  title={v.label}
                  loading="lazy"
                  frameborder="0"
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                  allowfullscreen
                ></iframe>
              ) : (
                <div class="placeholder">
                  <div class="placeholder-inner">
                    <span class="placeholder-title">Video coming soon</span>
                    <span class="placeholder-sub">Check back later!</span>
                  </div>
                </div>
              )}
            </div>
          ))}
        </div>
      </section>
    )}

    <!-- ═══ About Section ═══ -->
    {inst.about_html && (
      <section class="prose-block">
        <h2 class="font-display text-2xl md:text-3xl">About this instrument</h2>
        <div class="opacity-80" set:html={inst.about_html} />

        <Divider />

        <!-- ═══ Recommended Moods ═══ -->
        {moods.length > 0 && (
          <section class="recommended-moods grid md:grid-cols-2 gap-6 items-center py-10">
            <div class="space-y-5 order-1 md:order-2">
              <h2 class="font-display text-2xl md:text-3xl mb-2">
                Recommended
                <span class="moods-title">
                  <span class="m1">M</span>
                  <span class="m2">o</span>
                  <span class="m3">o</span>
                  <span class="m4">d</span>
                  <span class="m5">s</span>
                </span>
                for this instrument
              </h2>

              {inst.moods_intro && (
                <p class="opacity-80 text-base mb-4">{inst.moods_intro}</p>
              )}

              <ul class="space-y-3">
                {moods.map((m: any) => (
                  <li class="flex items-center justify-between rounded-xl px-3 py-2 frame">
                    <span class="font-medium">{m.label}</span>
                    <button
                      type="button"
                      class="opacity-70 hover:opacity-100 transition"
                      data-audio={m.audio_file}
                      aria-label={`Play ${m.label}`}
                    >
                      ▶︎
                    </button>
                  </li>
                ))}
              </ul>
            </div>

            {inst.image_url && (
              <figure class="rounded-xl overflow-hidden frame border border-black/40 shadow-soft order-2 md:order-1">
                <img
                  src={inst.image_url}
                  alt={inst.image_alt || inst.name}
                  class="object-cover w-full h-full aspect-[4/3]"
                  loading="lazy"
                />
              </figure>
            )}
          </section>
        )}
      </section>
    )}

    <!-- ═══ Back Link ═══ -->
    <div class="pt-8">
      <a
        href="/instruments"
        class="inline-flex items-center gap-2 font-display text-lg text-[var(--accent-gold)] hover:text-[var(--accent-rosewood)] transition-colors duration-200 group"
      >
        <span>Explore More Instruments</span>
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="1.8"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="w-5 h-5 transform transition-transform duration-300 group-hover:translate-x-1"
        >
          <path d="M5 12h14"></path>
          <path d="M13 5l7 7-7 7"></path>
        </svg>
      </a>
    </div>
  </section>

  <style lang="css">
  /* ===== Tab strip: always single row; mobile scroll instead of wrapping ===== */
  .tab-strip {
    display: flex;
    flex-wrap: nowrap;
    gap: 0.375rem;
    overflow-x: auto;
    overflow-y: hidden;
    -webkit-overflow-scrolling: touch;
    scroll-snap-type: x proximity;
    scrollbar-width: none;
    mask-image: linear-gradient(to right, transparent 0, #000 12px, #000 calc(100% - 12px), transparent 100%);
  }
  .tab-strip::-webkit-scrollbar { display: none; }

  /* ===== Tabs styling ===== */
  .tab-button {
    position: relative;
    flex: 0 0 auto;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.4ch;
    min-height: 2.2rem;
    padding: 0.55rem 0.9rem;
    border-radius: 0.75rem;
    font-weight: 600;
    line-height: 1;
    white-space: nowrap;
    min-width: max-content;
    background: transparent;
    color: var(--ivory);
    border: 1px solid transparent;
    transition: transform 160ms ease, background 160ms ease, border-color 160ms ease;
    outline: none;
    scroll-snap-align: start;
  }
  .tab-button::after {
    content: "";
    position: absolute;
    left: 0.9rem;
    right: 0.9rem;
    bottom: -2px;
    height: 2px;
    background: var(--accent-gold);
    transform: scaleX(0);
    transform-origin: left center;
    transition: transform 220ms ease;
    opacity: 0.9;
    filter: drop-shadow(0 0 6px rgba(194,164,95,0.65));
  }
  .tab-button:hover { transform: translateY(-1px); }
  .tab-button:hover::after { transform: scaleX(1); }
  .tab-button[aria-selected="true"] {
    border-color: rgba(255,255,255,0.1);
    background: rgba(255,255,255,0.04);
    box-shadow: inset 0 0 0 1px rgba(0,0,0,0.35);
  }
  .tab-button[aria-selected="true"]::after { transform: scaleX(1); }

  /* ===== Crossfade panes ===== */
  #video-shell { position: relative; }
  .video-pane {
    position: absolute;
    inset: 0;
    opacity: 0;
    pointer-events: none;
    transition: opacity 320ms ease;
    background: #000;
    display: flex;
  }
  .video-pane.is-active {
    opacity: 1;
    pointer-events: auto;
  }

  /* ===== Placeholder ===== */
  .placeholder {
    position: relative;
    width: 100%;
    height: 100%;
    background:
      radial-gradient(1200px 500px at 10% 10%, rgba(194,164,95,0.08), transparent 60%),
      radial-gradient(1000px 500px at 90% 30%, rgba(110,42,42,0.12), transparent 60%),
      rgba(0,0,0,0.5);
    display: grid;
    place-items: center;
  }
  .placeholder-inner {
    text-align: center;
    padding: 1rem 1.25rem;
    border-radius: 0.75rem;
    background: rgba(0,0,0,0.35);
    border: 1px solid rgba(255,255,255,0.08);
    box-shadow: inset 0 0 0 1px rgba(0,0,0,0.35);
  }
  .placeholder-title {
    display: block;
    font-weight: 700;
    font-size: 1.15rem;
    color: var(--ivory);
  }
  .placeholder-sub {
    display: block;
    margin-top: 0.25rem;
    opacity: 0.7;
  }

  /* ===== Prose block ===== */
  .prose-block { display: grid; gap: 0.75rem; }

  .prose-block a {
    color: var(--accent-gold);
    text-decoration: none;
    transition: color 0.25s ease;
  }

  /* ===== Recommended moods ===== */
  .recommended-moods img {
    object-position: center;
    filter: brightness(0.95) contrast(1.05);
  }
  .recommended-moods li.frame {
    background: linear-gradient(to right, rgba(205,127,50,0.15), transparent);
    border-radius: 0.75rem;
    position: relative;
    overflow: hidden;
  }
  .recommended-moods li.frame::before {
    content: "";
    position: absolute;
    inset: 0;
    border-radius: inherit;
    padding: 1px;
    background: linear-gradient(to right, rgba(205,127,50,0.8), transparent);
    -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
    -webkit-mask-composite: xor;
            mask-composite: exclude;
    pointer-events: none;
  }
  .recommended-moods button[data-audio] {
    font-size: 1.5rem;
    color: var(--accent-gold, #C2A45F);
    text-shadow:
      2px 0 var(--bronze, #CD7F32),
     -2px 0 var(--bronze, #CD7F32),
      0 2px var(--bronze, #CD7F32),
      0 -2px var(--bronze, #CD7F32);
  }
  @media (max-width: 768px) {
    .recommended-moods { text-align: center; }
    .recommended-moods ul { max-width: 24rem; margin-inline: auto; }
  }

  /* ===== "Moods" stylization ===== */
  .moods-title {
    display: inline-flex;
    gap: 0.05ch;
    margin: 0 0.25ch;
    letter-spacing: 0.015em;
    line-height: 1;
    font-family: var(--font-display, "Cinzel"), serif;
    font-weight: 600;
  }
  .moods-title span {
    text-shadow: 0 0 6px rgba(0,0,0,0.25);
    mix-blend-mode: soft-light;
    transition: transform 220ms ease, filter 220ms ease, text-shadow 220ms ease;
    animation: shimmer 8s ease-in-out infinite;
    animation-delay: calc(var(--i, 0) * 1s);
  }
  .moods-title span:hover {
    transform: scale(1.07);
    filter: brightness(1.1);
    text-shadow: 0 0 10px rgba(255,255,255,0.25);
  }

  /* Rebalanced "Moods" palette — blue ➜ plum ➜ rosewood */
  .m1 { color: #2C4C76; --i: 0; }
  .m2 { color: #4F6C89; --i: 1; }
  .m3 { color: #6B5A7A; --i: 2; }
  .m4 { color: #7A4F4B; --i: 3; }
  .m5 { color: #6E2A2A; --i: 4; }
  .m3, .m4 { filter: saturate(0.85); }

  @keyframes shimmer {
    0%   { filter: brightness(1); }
    50%  { filter: brightness(1.1) saturate(1.1); }
    100% { filter: brightness(1); }
  }

  @media (max-width: 360px) {
    .tab-button { padding-inline: 0.7rem; }
    .tab-button::after { left: 0.7rem; right: 0.7rem; }
  }
  </style>

  <script type="module">
  // Tab behavior + adaptive aspect ratio
  const tablist = document.querySelector('[role="tablist"]');
  const shell = document.getElementById('video-shell');
  const buttons = tablist ? Array.from(tablist.querySelectorAll('.tab-button')) : [];
  const panes = Array.from(document.querySelectorAll('.video-pane'));

  const ratioMap = new Map();

  const setShellRatio = (ratioString) => {
    if (!shell) return;
    shell.style.setProperty('--ar', ratioString || '16 / 9');
  };

  const measurePane = (pane) => {
    const manual = pane.getAttribute('data-ratio');
    if (manual && manual.includes('/')) {
      ratioMap.set(pane.id, manual);
      return;
    }

    const vid = pane.querySelector('video');
    if (vid) {
      const apply = () => {
        const w = vid.videoWidth, h = vid.videoHeight;
        if (w && h) ratioMap.set(pane.id, `${w} / ${h}`);
      };
      if (vid.readyState >= 1) {
        apply();
      } else {
        vid.addEventListener('loadedmetadata', apply, { once: true });
      }
      return;
    }

    const ifr = pane.querySelector('iframe');
    if (ifr) {
      ratioMap.set(pane.id, manual || '16 / 9');
    }
  };

  panes.forEach(measurePane);

  const activate = (id) => {
    for (const btn of buttons) {
      const isSelected = btn.dataset.tab === id;
      btn.setAttribute('aria-selected', isSelected ? 'true' : 'false');
      btn.tabIndex = isSelected ? 0 : -1;
    }
    for (const pane of panes) {
      const isActive = pane.dataset.pane === id;
      pane.classList.toggle('is-active', isActive);

      if (!isActive) {
        const vid = pane.querySelector('video');
        if (vid) vid.pause();
        const ifr = pane.querySelector('iframe');
        if (ifr) { const src = ifr.src; ifr.src = src; }
      } else {
        const r = ratioMap.get(pane.id) || pane.getAttribute('data-ratio') || '16 / 9';
        setShellRatio(r);
      }
    }
  };

  if (tablist) {
    tablist.addEventListener('click', (e) => {
      const btn = e.target.closest('.tab-button');
      if (!btn) return;
      activate(btn.dataset.tab);
    });

    tablist.addEventListener('keydown', (e) => {
      const currentIndex = buttons.findIndex(b => b.getAttribute('aria-selected') === 'true');
      if (e.key === 'ArrowRight' || e.key === 'Right') {
        const next = buttons[(currentIndex + 1) % buttons.length];
        next.focus(); activate(next.dataset.tab); e.preventDefault();
      } else if (e.key === 'ArrowLeft' || e.key === 'Left') {
        const prev = buttons[(currentIndex - 1 + buttons.length) % buttons.length];
        prev.focus(); activate(prev.dataset.tab); e.preventDefault();
      } else if (e.key === 'Enter' || e.key === ' ') {
        const btn = document.activeElement;
        if (btn && btn.classList.contains('tab-button')) {
          activate(btn.dataset.tab); e.preventDefault();
        }
      }
    });
  }

  const initiallyActive = panes.find(p => p.classList.contains('is-active')) || panes[0];
  if (initiallyActive) {
    const applyInitial = () => {
      const r = ratioMap.get(initiallyActive.id) || initiallyActive.getAttribute('data-ratio') || '16 / 9';
      setShellRatio(r);
    };

    const vid = initiallyActive.querySelector('video');
    if (vid && !(vid.readyState >= 1)) {
      vid.addEventListener('loadedmetadata', applyInitial, { once: true });
    } else {
      applyInitial();
    }
  }

  const initiallySelected = buttons.find(b => b.getAttribute('aria-selected') === 'true') || buttons[0];
  buttons.forEach(b => (b.tabIndex = b === initiallySelected ? 0 : -1));

  // Audio play behavior for mood buttons
  document.addEventListener('DOMContentLoaded', () => {
    const supportsHover = window.matchMedia('(hover: hover)').matches;
    const players = new Map();
    let current = null;

    const getPlayer = (src) => {
      if (!players.has(src)) {
        const a = new Audio(src);
        a.preload = 'none';
        players.set(src, a);
      }
      return players.get(src);
    };

    const stopCurrent = () => {
      if (current && !current.paused) {
        current.pause();
        current.currentTime = 0;
      }
    };

    const play = async (src) => {
      stopCurrent();
      const a = getPlayer(src);
      current = a;
      a.currentTime = 0;
      a.volume = 0.9;
      try { await a.play(); } catch {}
    };

    document.querySelectorAll('[data-audio]').forEach(btn => {
      const src = btn.getAttribute('data-audio');
      btn.addEventListener('click', () => play(src), { passive: true });
      if (supportsHover) {
        btn.addEventListener('mouseenter', () => play(src));
        btn.addEventListener('mouseleave', () => stopCurrent());
        btn.addEventListener('blur', () => stopCurrent());
      }
    });

    document.addEventListener('visibilitychange', () => {
      if (document.hidden) stopCurrent();
    });
  });
  </script>
</BaseLayout>